## Diff Review Summary

Scope: 5 files changed, 1050 insertions, 358 deletions
Intent: Enhance `start show` from a basic metadata viewer into a comprehensive resource inspection tool with cross-category search, verbose dump output, enhanced listing with descriptions, and interactive selection for ambiguous matches.
Findings: 0 critical, 0 high, 2 medium, 4 low

## Critical Findings

None

## High Findings

None

## Medium Findings

### M1. Nil dereference risk in `showCategoryFor` callers

`show.go:46` - `showCategoryFor()` returns `*showCategory` which can be nil if the category string is not found. Callers at lines 225, 243, and 302 dereference the result without nil checks:

```go
cat := showCategoryFor(exactMatches[0].Category)
return showVerboseItem(w, exactMatches[0].Name, scope, cat.key, cat.itemType)
```

In the current code, the `Category` field always originates from the `showCategories` slice, so nil is not reachable. However, this is fragile. If a future change introduces an `AssetMatch` with an unrecognised category string, it would panic with no helpful error message.

Suggestion: Add a nil guard or change `showCategoryFor` to return a zero value with a bool, consistent with Go map lookup idiom.

### M2. Known bug documented but not fixed: `start show review` vs `start show review/`

`p-029-cli-show-verbose-inspection.md:225` documents that `start show review` finds an exact short-name match and displays it directly, while `start show review/` shows all review items. The project document identifies the fix (mirror the pattern from `task.go` ~line 162-185: after finding an exact match, also run substring search and fall through if more matches exist).

This is a user-facing inconsistency that may confuse users. Noted here since the project document acknowledges it as a known bug to fix.

## Low / Info

### L1. Extra CUE loads in `findConfigSource`

`show.go:584` - `findConfigSource()` calls `loader.LoadSingle()` on each config directory (up to 2 loads) every time a verbose dump is rendered. This is in addition to the primary config load in `prepareShow()`. For a CLI show command the latency is acceptable, but it is worth noting as a potential optimisation target if show commands are ever called in batch.

### L2. `@module/` path without origin silently falls through

`show.go:643` - `resolveShowFile` checks `strings.HasPrefix(filePath, "@module/") && origin != ""`. If origin is empty, the `@module/` path falls through to `ExpandFilePath`, which will likely fail since `@module/` is not a valid filesystem path. The error would be reported as an inline `[error: ...]` in the verbose dump, so the user would see it, but the error message would reference a filesystem error rather than a missing origin field.

This is acceptable given that `@module/` without origin is an invalid configuration state, and the verbose dump already displays the CUE definition which makes the missing origin visible.

### L3. Test coverage for `promptShowSelection` TTY path

`show.go:318` - The TTY interactive selection path in `promptShowSelection()` is not directly tested (tests run in non-TTY mode). The non-TTY error path is tested (`TestShowCrossCategoryMultipleExact`). The TTY path follows the established pattern from `resolve.go` and `task.go`, so the risk is low.

### L4. `ShowResult.AllNames` unused in verbose dump

`show.go:28` - The `AllNames` field is populated in `prepareShow()` and used in tests to verify config loading, but `printVerboseDump()` does not display it. The old `printPreview()` showed "Agents: claude, gemini" as a list header. This is a deliberate design change (the verbose dump focuses on a single item), so the field serves only as test infrastructure now. Consider whether it should remain in the struct or be returned separately.

## Assessment

This is a well-implemented feature addition that transforms the show command from a basic metadata viewer into a proper inspection tool. Key strengths:

- Clean decomposition: `runShowListing`, `runShowSearch`, `showVerboseItem`, `printVerboseDump`, and supporting functions each have clear responsibilities.
- The cross-category search correctly follows the established three-tier resolution pattern from `resolve.go`, maintaining consistency with `start task` and flag-based resolution.
- The composer.go changes are minimal and mechanical (5 unexported-to-exported renames), avoiding unnecessary refactoring.
- Test coverage is comprehensive: 16+ test functions covering CUE definitions, config source paths, origin/cache display, file content, file errors, commands, separators, listing with/without descriptions, cross-category search, and ambiguous matches.
- The `findConfigSource()` strategy (LoadSingle per config dir) is self-contained and avoids changes to the loader or other packages, matching the project document's design decision.
- Error handling is graceful throughout: missing files show inline errors, missing config sources are silently omitted, and CUE formatting failures produce empty output rather than errors.
- All tests pass via `scripts/invoke-tests`.

The code is ready to merge after considering the known bug (M2) and optionally the nil guard (M1).
