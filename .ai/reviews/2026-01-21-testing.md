# Testing Review

**Date:** 2026-01-21
**Status:** New

## Summary

Comprehensive review of test quality, coverage, and production code testability. Overall, the testing infrastructure is well-designed and follows the established testing strategy (DR-024). The codebase demonstrates good testing practices with room for improvement in specific areas.

## Coverage Analysis

Current test coverage by package:

| Package | Coverage | Assessment |
|---------|----------|------------|
| internal/detection | 100.0% | Excellent |
| internal/shell | 88.1% | Good |
| internal/temp | 83.9% | Good |
| internal/config | 81.2% | Good (meets 80%+ goal) |
| internal/registry | 78.5% | Good |
| internal/orchestration | 72.9% | Good (meets 70%+ goal) |
| internal/cue | 69.1% | Acceptable |
| internal/doctor | 57.9% | Below target |
| internal/cli | 46.9% | Below target (has failing test) |

**Overall Assessment:** 7 of 9 packages meet or exceed the coverage targets defined in DR-024.

### Failing Test

The `TestFindTask` test in `internal/cli/start_test.go:362` is currently failing:

```
--- FAIL: TestFindTask/prefix_match (0.00s)
    start_test.go:362: unexpected multiple matches: [golang/review/testing test-task]
```

The test expects a single match for the prefix "test" but receives two matches. This appears to be caused by test data pollution from the `golang/review/testing` task which was not present when the test was written.

**Recommendation:** Update the test configuration in `setupStartTestConfig` to use a more unique task name, or update the test expectation to handle the presence of registry tasks.

## Test Quality Assessment

### Strengths

1. **Table-Driven Tests:** Extensively used throughout the codebase
   - `internal/cue/loader_test.go`: Comprehensive merge semantics testing
   - `internal/config/paths_test.go`: Clear scope testing patterns
   - `internal/orchestration/template_test.go`: Process variations

2. **Real Behaviour Over Mocks:** Aligns with DR-024 principles
   - CUE validation uses actual CUE library, not mocks
   - File operations use `t.TempDir()` for real file system testing
   - Shell commands tested with real execution

3. **Helper Functions Properly Marked:**
   - `t.Helper()` consistently used (e.g., `setupStartTestConfig`, `setupTestConfig`, `writeCUEFile`)
   - Clear test setup patterns

4. **Subtests with `t.Run()`:** Well-organised test cases
   - Enables running individual cases in isolation
   - Clear naming conventions

5. **Parallel Testing:** `t.Parallel()` used appropriately
   - Unit tests in `internal/cue/`, `internal/config/`, `internal/doctor/`
   - Helps identify race conditions

6. **Integration Test Separation:** Proper build tag usage
   - `//go:build integration` for integration tests
   - `//go:build e2e` for end-to-end tests

7. **E2E Test Infrastructure:**
   - Custom cleanup handling for CUE cache read-only files
   - Proper environment isolation
   - Real binary execution testing

### Areas for Improvement

1. **Mock Usage Inconsistency:**
   The `mockShellRunner` in `internal/orchestration/template_test.go` is well-designed:
   ```go
   type mockShellRunner struct {
       output string
       err    error
       calls  []shellCall
   }
   ```
   However, not all packages that could benefit from similar mocks have them implemented.

2. **Missing Test Cleanup in Some Cases:**
   Some tests create files in home directory without guaranteed cleanup:
   - `internal/orchestration/composer_test.go:1089-1093` creates `~/.start-test-context.md`
   - Uses `defer os.Remove()` which may not execute on test failure

3. **Working Directory Changes:**
   Multiple tests use `os.Chdir()` pattern:
   ```go
   origDir, err := os.Getwd()
   defer func() { _ = os.Chdir(origDir) }()
   os.Chdir(tmpDir)
   ```
   This can cause issues in parallel tests if not properly isolated.

4. **Test Naming:**
   Some test names could be more descriptive:
   - `TestExecute_NoConfig` - skipped but documents why well
   - `TestDebugImpliesVerbose` - good descriptive name

## Testability Analysis

### Well-Designed for Testability

1. **Dependency Injection:**
   - `TemplateProcessor` accepts `FileReader` and `ShellRunner` interfaces
   - `Composer` accepts processor dependency
   - `Executor` accepts configuration struct

2. **Interface-Based Design:**
   ```go
   type ShellRunner interface {
       Run(command, workingDir, shell string, timeout int) (string, error)
   }
   ```

3. **Configuration Structs:**
   - `ExecuteConfig`, `ContextSelection`, `UTDFields` - clear data transfer objects
   - Easy to construct in tests

4. **Pure Functions:**
   - `ValidateCommandTemplate` - no side effects
   - `escapeForShell` - deterministic
   - `extractUTDFields` - pure CUE value extraction

### Testability Concerns

1. **Global State in CLI:**
   The `internal/cli/root.go` uses package-level `Flags` struct. While tests work around this by creating fresh commands, it could cause issues in parallel testing.

2. **syscall.Exec in Executor:**
   The `Execute` method in `internal/orchestration/executor.go:201` uses `syscall.Exec` which replaces the process. The codebase provides `ExecuteWithoutReplace` for testing, which is good design.

3. **Time Dependencies:**
   `internal/orchestration/executor.go:145` uses `time.Now()` directly:
   ```go
   "date": escapeForShell(time.Now().Format(time.RFC3339)),
   ```
   This is acceptable as per DR-024 (only mock time when specifically testing time-based logic).

4. **Environment Variable Access:**
   Direct `os.Getenv` and `os.Setenv` usage. Tests use `t.Setenv()` or manual save/restore, which is appropriate.

## Test Infrastructure

### Positive Observations

1. **Test Script (`scripts/invoke-tests`):**
   - Single entry point for all test types
   - Handles binary building for E2E tests
   - Supports coverage, verbose, and short mode flags

2. **Test Directory Structure:**
   ```
   test/
   ├── integration/
   │   ├── autosetup_test.go
   │   ├── cli_test.go
   │   ├── assets_test.go
   │   └── doctor_test.go
   ├── e2e/
   │   └── autosetup_test.go
   └── testdata/
       └── merge/
   ```

3. **Testdata Fixtures:**
   Real CUE files in `test/testdata/merge/` for realistic merge testing.

### Missing Infrastructure

1. **Race Detection in CI:**
   The test script doesn't include `-race` flag by default. Consider adding:
   ```bash
   test_args+=("-race")
   ```

2. **Benchmark Tests:**
   No benchmark tests present. Consider adding for:
   - CUE loading and merging
   - Template processing
   - Command building

3. **Fuzz Testing:**
   No fuzz tests present. Good candidates:
   - Template parsing (`internal/orchestration/template.go`)
   - Command template validation (`internal/orchestration/executor.go`)
   - CUE path parsing

4. **Goroutine Leak Detection:**
   No `goleak` integration. Consider adding to `TestMain`:
   ```go
   func TestMain(m *testing.M) {
       goleak.VerifyTestMain(m)
   }
   ```

## Recommendations

### High Priority

1. **Fix Failing Test:**
   Update `TestFindTask` in `internal/cli/start_test.go` to handle the registry task pollution:
   ```go
   // Option 1: Use more unique task name
   tasks: {
       "cli-test-unique-task": { ... }
   }

   // Option 2: Isolate HOME to prevent global config loading
   oldHome := os.Getenv("HOME")
   os.Setenv("HOME", tmpDir)
   defer os.Setenv("HOME", oldHome)
   ```

2. **Improve Doctor Package Coverage:**
   Current: 57.9%, Target: 70%+
   - Add tests for `CheckAgents` function
   - Add tests for `CheckRegistry` function
   - Add edge case tests for path expansion

3. **Improve CLI Package Coverage:**
   Current: 46.9%, Target: 70%+
   - Add tests for `config_*.go` command files
   - Add tests for `assets_*.go` command files
   - Add error path testing

### Medium Priority

4. **Add Race Detection to Test Script:**
   ```bash
   # Add to scripts/invoke-tests
   if [[ "${race}" == true ]]; then
       test_args+=("-race")
   fi
   ```

5. **Add Benchmark Tests:**
   Create `internal/cue/loader_bench_test.go`:
   ```go
   func BenchmarkLoader_Load(b *testing.B) {
       // Setup
       for i := 0; i < b.N; i++ {
           l := NewLoader()
           l.Load([]string{globalDir, localDir})
       }
   }
   ```

6. **Standardise Test Helper Location:**
   Consider creating `internal/testutil/` for shared helpers:
   - `SetupTestConfig`
   - `CreateCUEFile`
   - `MockShellRunner`

### Low Priority

7. **Add Fuzz Tests:**
   Create `internal/orchestration/executor_fuzz_test.go`:
   ```go
   func FuzzValidateCommandTemplate(f *testing.F) {
       f.Add("{{.bin}} --model {{.model}}")
       f.Add("{prompt}")
       f.Add("'{{.prompt}}'")
       f.Fuzz(func(t *testing.T, tmpl string) {
           _ = ValidateCommandTemplate(tmpl)
       })
   }
   ```

8. **Add Goroutine Leak Detection:**
   Install and configure `go.uber.org/goleak` for packages with concurrency.

9. **Document Test Patterns:**
   Create `docs/contributing/testing.md` documenting:
   - How to run tests
   - Test organisation conventions
   - Mock patterns in use

## Summary

The testing infrastructure is well-aligned with DR-024 principles:
- Real behaviour over mocks
- Build tags for test separation
- Table-driven tests
- Single script entry point

Key actions needed:
1. Fix the failing `TestFindTask` test
2. Improve coverage in `internal/doctor` and `internal/cli` packages
3. Add race detection to the test script

The codebase demonstrates good testability through interface-based design and dependency injection. Production code is generally well-structured for testing with clear separation of concerns.
